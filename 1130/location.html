<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>裝置位置監控</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif; margin: 20px; background: #f7f8fb; }
    .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    h1 { margin-top: 0; }
    .btn { background: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; margin: 5px 0; }
    .btn:hover { background: #45a049; }
    #stateDisplay { background: #f0f0f0; padding: 16px; border-radius: 6px; white-space: pre-wrap; font-family: monospace; }
  </style>
</head>
<body>
  <div class="container">
    <h1>裝置位置監控</h1>

    <div id="status">初始化中，請允許位置權限…</div>

    <button class="btn" onclick="deviceManager.setupGeolocation()">重新請求位置權限</button>

    <h3>即時位置資訊：</h3>
    <pre id="stateDisplay">等待資料…</pre>
  </div>

  <script>

class DeviceStateManager {
  constructor() {
    this.state = {
      lat: null,
      lon: null
    };

    this.permissionsGranted = {
      geolocation: false
    };

    this.init();
  }

  async init() {
    try {
      await this.requestPermissions();
      this.setupGeolocation();
    } catch (error) {
      console.error("初始化失敗:", error);
    }
  }

  async requestPermissions() {
    try {
      const geoPermission = await navigator.permissions.query({ name: 'geolocation' });
      this.permissionsGranted.geolocation = geoPermission.state === 'granted';

      if (geoPermission.state === 'prompt') {
        await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 1000 });
        });
        this.permissionsGranted.geolocation = true;
      }
    } catch (error) {
      console.log("地理位置權限可能需要使用者互動");
    }
  }

  setupGeolocation() {
    if (!('geolocation' in navigator)) {
      console.warn("地理位置 API 不支援");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => { this.updateGeolocation(pos); this.startGeolocationWatch(); },
      (err) => this.handleGeolocationError(err),
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  }

  startGeolocationWatch() {
    this.watchId = navigator.geolocation.watchPosition(
      (position) => this.updateGeolocation(position),
      (error) => console.error("位置監聽錯誤", error),
      { enableHighAccuracy: true, timeout: 5000, maximumAge: 1000 }
    );
  }

  updateGeolocation(position) {
    this.state.lat = position.coords.latitude;
    this.state.lon = position.coords.longitude;
    this.onStateUpdate();
  }

  handleGeolocationError(error) {
    console.error("地理位置錯誤：", error);
    statusDiv.textContent = "無法取得位置：" + error.message;
  }

  onStateUpdate() {
    if (this.onUpdateCallback) this.onUpdateCallback(this.state);
  }

  getState() { return { ...this.state }; }
  setUpdateCallback(callback) { this.onUpdateCallback = callback; }
}

const deviceManager = new DeviceStateManager();
const stateDisplay = document.getElementById('stateDisplay');
const statusDiv = document.getElementById('status');

deviceManager.setUpdateCallback((state) => {
  stateDisplay.textContent = JSON.stringify(state, null, 2);
  statusDiv.textContent = '位置資料更新中…';
});

  </script>
</body>
</html>